# Настройка сервера

Инструкция по первоначальной настройке сервера для production.

## КРИТИЧЕСКИ ВАЖНО: JWT секретные ключи

**Обязательно измените секретные ключи перед запуском в production!**

По умолчанию используются небезопасные ключи. Без изменения секретов ваш API будет уязвим.

## Быстрая настройка

### 1. Создайте .env файл

```bash
cd /path/to/your/project
cp env.example .env
```

### 2. Сгенерируйте безопасные ключи

```bash
# Генерация первого ключа для JWT_SECRET
openssl rand -base64 32

# Генерация второго ключа для JWT_REFRESH_SECRET
openssl rand -base64 32
```

**Важно:** Используйте разные ключи для `JWT_SECRET` и `JWT_REFRESH_SECRET`!

### 3. Отредактируйте .env файл

```bash
nano .env
```

Замените значения на сгенерированные ключи:

```env
JWT_SECRET=ваш-первый-сгенерированный-ключ
JWT_REFRESH_SECRET=ваш-второй-сгенерированный-ключ
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=30d
PORT=3001
NODE_ENV=production
API_URL=http://XXX.XXX.XXX.XXX:3001

# Опционально (для production)
# ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
# RATE_LIMIT_MAX=100
# AUTH_RATE_LIMIT_MAX=5
```

### 4. Перезапустите сервер

```bash
pm2 restart skillswap-api
```

## Переменные окружения

### JWT_SECRET (секретный ключ для access токенов)

- **Что это:** Секретный ключ для подписи и проверки access токенов
- **Когда менять:** Только один раз при настройке, или если был скомпрометирован
- **Требования:** Минимум 32 символа, случайный
- **Пример генерации:** `openssl rand -base64 32`

### JWT_REFRESH_SECRET (секретный ключ для refresh токенов)

- **Что это:** Секретный ключ для подписи и проверки refresh токенов
- **Когда менять:** Только один раз при настройке, или если был скомпрометирован
- **Важно:** Должен отличаться от `JWT_SECRET`!
- **Пример генерации:** `openssl rand -base64 32`

### JWT_EXPIRES_IN (время жизни access токена)

- **Что это:** Время, в течение которого access токен действителен
- **Рекомендуемое значение:** `15m` (15 минут) или `1h` (1 час)
- **Как работает:** После истечения используйте refresh токен для получения нового access токена
- **Примеры:** `15m`, `1h`, `30m`

### JWT_REFRESH_EXPIRES_IN (время жизни refresh токена)

- **Что это:** Время, в течение которого refresh токен действителен
- **Рекомендуемое значение:** `30d` (30 дней) или `7d` (7 дней)
- **Как работает:** После истечения пользователь должен залогиниться заново
- **Примеры:** `30d`, `7d`, `14d`

### PORT (порт сервера)

- **По умолчанию:** `3001`
- **Можно изменить:** Укажите другой порт в `.env`

### NODE_ENV (окружение)

- **Для production:** `production`
- **Для development:** `development`

## Как это работает

### Access Token (токен доступа)

- Используется для доступа к защищенным эндпоинтам
- Время жизни: ~15 минут (настраивается через `JWT_EXPIRES_IN`)
- Передается в заголовке: `Authorization: Bearer <accessToken>`

### Refresh Token (токен обновления)

- Используется для получения нового access токена без повторного входа
- Время жизни: ~30 дней (настраивается через `JWT_REFRESH_EXPIRES_IN`)
- Хранится безопасно на клиенте (httpOnly cookies, secure storage)

### Пример работы

1. **Пользователь логинится** → получает `accessToken` (15 минут) и `refreshToken` (30 дней)
2. **Access токен истекает** через 15 минут → клиент автоматически использует `refreshToken` для получения нового
3. **Refresh токен истекает** через 30 дней → пользователь должен залогиниться заново
4. **При выходе** (`/api/auth/logout`) refresh токен отзывается

**Преимущества:**
- Пользователь не замечает истечения access токена (автоматическое обновление)
- Более безопасно (access токен живет короткое время)
- Можно отозвать refresh токен при выходе
- Не нужно логиниться каждые 15 минут

## Проверка настройки

После настройки проверьте:

```bash
# 1. Проверьте, что .env файл существует
ls -la .env

# 2. Проверьте переменные (без показа секретов)
cat .env | grep -E "^JWT_|^PORT|^NODE_ENV"

# 3. Проверьте логи
pm2 logs skillswap-api --lines 20

# 4. Проверьте работу API
curl http://localhost:3001/api/health
```

## Проверка переменных окружения в PM2

Если получаете ошибку `[PM2][ERROR] Modules with id skillswap-api not found`, значит процесс не запущен.

### Проверка статуса PM2

```bash
# Проверьте статус
pm2 status

# Если процесса нет, запустите его
cd /path/to/your/project
pm2 start ecosystem.config.cjs
```

### Проверка переменных процесса

После запуска процесса можно проверить переменные:

```bash
# Проверка всех переменных процесса
pm2 show skillswap-api | grep -A 20 "env:"

# Или через PM2 CLI
pm2 describe skillswap-api

# Проверка переменных окружения
pm2 env skillswap-api | grep JWT
```

### Если процесс не запускается

```bash
# 1. Проверьте, что файл dist/index.js существует
ls -la dist/index.js

# 2. Проверьте ошибки компиляции
npm run build

# 3. Попробуйте запустить вручную
node dist/index.js

# 4. Если работает вручную, запустите через PM2
pm2 start ecosystem.config.cjs
```

## Безопасность

1. **Никогда не коммитьте секретные ключи в git!**
   - Файл `.env` уже добавлен в `.gitignore`
   - Используйте `env.example` как шаблон

2. **Используйте разные ключи для access и refresh токенов**

3. **Ключи должны быть длинными (минимум 32 символа)**

4. **Храните ключи в переменных окружения, а не в коде**

5. **Используйте HTTPS** для передачи токенов

6. **Храните токены безопасно** на клиенте (не в localStorage для веб-приложений, лучше в httpOnly cookies)

## Что произойдет, если не изменить ключи?

- Любой, кто знает дефолтные ключи, сможет подделать токены
- Безопасность вашего API будет скомпрометирована
- Пользователи могут получить доступ к чужим данным

## Резервное копирование

Сохраните секретные ключи в безопасном месте (например, в менеджере паролей):

- `JWT_SECRET` - для access токенов
- `JWT_REFRESH_SECRET` - для refresh токенов

**Важно:** Если потеряете ключи, все существующие токены станут недействительными, и пользователям придется залогиниться заново.

## Часто задаваемые вопросы

### Нужно ли менять JWT_SECRET каждые 7 дней?
**Нет!** JWT_SECRET меняется только если был скомпрометирован.

### Нужно ли менять JWT_EXPIRES_IN каждые 7 дней?
**Нет!** Это настройка времени жизни токена. Токены истекают автоматически.

### Что если пользователь не залогинился 7 дней?
Токен истечет, и пользователь должен будет залогиниться заново. Это нормально и безопасно.

### Можно ли сделать токены бессрочными?
Технически можно установить `JWT_EXPIRES_IN` на очень большое значение, но это **не рекомендуется** из соображений безопасности.

### Как изменить время жизни токена?
Просто измените значение `JWT_EXPIRES_IN` в `.env` файле и перезапустите сервер. Новые токены будут иметь новое время жизни.

## Полный пример настройки на сервере

```bash
# 1. Подключитесь к серверу
ssh root@your-server

# 2. Перейдите в директорию проекта
cd /path/to/your/project

# 3. Создайте .env файл
cp env.example .env

# 4. Сгенерируйте ключи
JWT_SECRET=$(openssl rand -base64 32)
JWT_REFRESH_SECRET=$(openssl rand -base64 32)

# 5. Отредактируйте .env файл
nano .env
# Замените JWT_SECRET и JWT_REFRESH_SECRET на сгенерированные ключи

# 6. Перезапустите
pm2 restart skillswap-api

# 7. Проверьте
pm2 logs skillswap-api --lines 20
curl http://localhost:3001/api/health
```

