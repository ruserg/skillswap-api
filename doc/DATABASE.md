# Структура базы данных

API использует JSON файлы из папки `public/db/` как базу данных. Все файлы содержат массивы объектов.

## Инициализация базы данных

При первом запуске создайте пустые файлы базы данных:

```bash
npm run init-db
```

Это создаст все необходимые JSON файлы с пустыми массивами в папке `public/db/`.

## Файлы базы данных

- `users.json` - пользователи
- `skills.json` - навыки/объявления
- `categories.json` - категории
- `subcategories.json` - подкатегории
- `cities.json` - города
- `likes.json` - лайки
- `refresh-tokens.json` - refresh токены (создается автоматически)

## Структура данных

### users.json

```typescript
interface User {
  id: number;                    // Уникальный ID пользователя
  email: string;                 // Email (уникальный, обязательный)
  password: string;              // Хешированный пароль (bcrypt, обязательный)
  name: string;                  // Имя пользователя (обязательный)
  firstName: string;             // Имя (обязательный)
  lastName: string;              // Фамилия (обязательный)
  dateOfBirth: string;           // Дата рождения в формате ISO (обязательный)
  gender: "M" | "F";            // Пол (обязательный)
  cityId: number;                // ID города (обязательный)
  avatarUrl: string;             // URL аватара (обязательный, создается при регистрации)
  dateOfRegistration: string;   // Дата регистрации в формате ISO (обязательный)
  lastLoginDatetime: string;     // Дата последнего входа в формате ISO (обязательный)
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "email": "user@example.com",
    "password": "$2b$10$abcdefghijklmnopqrstuvwxyz1234567890",
    "name": "Иван Иванов",
    "firstName": "Иван",
    "lastName": "Иванов",
    "dateOfBirth": "1990-01-01",
    "gender": "M",
    "cityId": 1,
    "avatarUrl": "http://your-server.com/uploads/avatars/avatar-1234567890.jpg",
    "dateOfRegistration": "2024-01-01T00:00:00.000Z",
    "lastLoginDatetime": "2024-01-15T10:30:00.000Z"
  }
]
```

**Важно:** Все поля обязательны. При регистрации через API все поля должны быть предоставлены.

**Важно:**
- Пароль всегда хешируется с помощью bcrypt перед сохранением
- Пароль никогда не возвращается в ответах API
- `avatarUrl` создается автоматически при регистрации

### skills.json

```typescript
interface Skill {
  id: number;                    // Уникальный ID навыка
  userId: number;                 // ID пользователя-владельца (обязательный)
  subcategoryId: number;          // ID подкатегории (обязательный)
  title: string;                  // Заголовок (обязательный)
  description: string;            // Описание (обязательный)
  type_of_proposal: "offer" | "request";  // Тип предложения (обязательный)
  modified_datetime: string;      // Дата последнего изменения в формате ISO
  images: string[];               // Массив URL изображений
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "userId": 1,
    "subcategoryId": 1,
    "title": "Уроки программирования",
    "description": "Обучаю JavaScript и TypeScript",
    "type_of_proposal": "offer",
    "modified_datetime": "2024-01-15T10:30:00.000Z",
    "images": []
  }
]
```

### categories.json

```typescript
interface Category {
  id: number;                    // Уникальный ID категории
  name: string;                   // Название категории (обязательный)
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "name": "Образование"
  }
]
```

### subcategories.json

```typescript
interface Subcategory {
  id: number;                    // Уникальный ID подкатегории
  categoryId: number;            // ID родительской категории (обязательный)
  name: string;                   // Название подкатегории (обязательный)
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "categoryId": 1,
    "name": "Программирование"
  }
]
```

### cities.json

```typescript
interface City {
  id: number;                    // Уникальный ID города
  name: string;                   // Название города (обязательный)
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "name": "Москва"
  }
]
```

### likes.json

```typescript
interface Like {
  id: number;                    // Уникальный ID лайка
  fromUserId: number;             // ID пользователя, который поставил лайк (обязательный)
  toUserId: number;              // ID пользователя, которому поставили лайк (обязательный)
  skillId?: number;               // ID навыка (опционально, для обратной совместимости)
  createdAt: string;              // Дата создания в формате ISO
}
```

**Пример:**
```json
[
  {
    "id": 1,
    "fromUserId": 1,
    "toUserId": 2,
    "skillId": 5,
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
]
```

**Важно:**
- Лайки привязаны к пользователям, а не к навыкам
- `fromUserId` - кто поставил лайк (берется из токена при создании)
- `toUserId` - кому поставили лайк
- Нельзя лайкнуть самого себя

### refresh-tokens.json

```typescript
interface RefreshToken {
  userId: number;                 // ID пользователя
  token: string;                  // Refresh токен
  createdAt: string;              // Дата создания в формате ISO
}
```

**Важно:**
- Этот файл создается автоматически при первом логине/регистрации
- Используется для хранения активных refresh токенов
- При выходе токены удаляются из этого файла

## Связи между таблицами

### Иерархия категорий
```
Category (1) ──< Subcategory (N)
```

### Навыки
```
User (1) ──< Skill (N)
Subcategory (1) ──< Skill (N)
```

### Лайки
```
User (1) ──< Like (N) [fromUserId]
User (1) ──< Like (N) [toUserId]
```

## Валидация данных

API использует библиотеку `zod` для валидации всех входных данных.

**Что валидируется:**
- Регистрация: email (формат), пароль (минимум 6 символов), обязательные поля
- Вход: email (формат), пароль (обязателен)
- Навыки: обязательные поля (subcategoryId, title, description, type_of_proposal)
- Категории, подкатегории, города: обязательные поля (name)
- Обновление пользователя: только разрешенные поля, валидация типов

**Ошибки валидации:**
Все ошибки возвращаются с кодом 400 и детальным описанием:
```json
{
  "error": "Ошибка валидации",
  "details": [
    {
      "field": "email",
      "message": "Некорректный email"
    }
  ]
}
```

Подробнее о схеме валидации см. `src/utils/validation.ts`.

При создании записей API автоматически проверяет:

1. **Уникальность ID**: ID генерируются автоматически на сервере и всегда уникальны. ID нельзя передать с клиента - они всегда генерируются на сервере.

2. **Существование связей** (проверяется автоматически):
   - `skills.subcategoryId` - проверяется существование в `subcategories` (ошибка 400 если не найден)
   - `subcategories.categoryId` - проверяется существование в `categories` (ошибка 400 если не найден)
   - `users.cityId` - проверяется существование в `cities` при регистрации (ошибка 400 если не найден)
   - `likes.toUserId` - проверяется существование в `users` (ошибка 400 если не найден)
   - `likes.fromUserId` - всегда берется из токена авторизации, поэтому всегда валиден
   - `skills.userId` - всегда берется из токена авторизации, поэтому всегда валиден

3. **Обязательные поля**: Все обязательные поля валидируются через Zod схемы (ошибка 400 если отсутствуют)

4. **Формат данных**: Даты в формате ISO 8601, email должен быть валидным (валидация через Zod)

**Важно:** Все проверки выполняются автоматически на сервере. При попытке создать запись с несуществующей связью API вернет ошибку 400 с сообщением вида: `"Город с ID X не найден"`.

См. [TESTS.md](./TESTS.md) для тестов проверки существования связей.

## Динамические поля

Некоторые поля вычисляются динамически и не хранятся в базе данных:

### Пользователи
- `likesCount` - количество лайков пользователя (вычисляется из `likes.json`)
- `isLikedByCurrentUser` - лайкнул ли текущий пользователь (вычисляется из `likes.json`)

Эти поля добавляются автоматически в ответах API и зависят от того, авторизован ли пользователь.

## Импорт данных

Для импорта данных из внешних JSON файлов используйте:

```bash
npm run import -- <путь_к_json_файлу> <имя_файла_в_бд>
```

**Примеры:**
```bash
npm run import -- ./data/users.json users.json
npm run import -- ./data/skills.json skills.json
```

Подробнее см. [IMPORT_DATA.md](./IMPORT_DATA.md).

## Расположение файлов

### Структура папок

```
project/
├── public/
│   ├── db/              # База данных (JSON файлы)
│   │   ├── users.json
│   │   ├── skills.json
│   │   ├── categories.json
│   │   ├── subcategories.json
│   │   ├── cities.json
│   │   ├── likes.json
│   │   └── refresh-tokens.json
│   └── uploads/         # Загруженные файлы
│       └── avatars/      # Аватары пользователей
│           ├── avatar-*.jpg
│           └── thumbnails/
│               ├── avatar-*-200x200.jpg
│               └── avatar-*-100x100.jpg
```

### Пути по умолчанию

По умолчанию файлы базы данных находятся в:
- `public/db/` (относительно корня проекта)

Загруженные файлы находятся в:
- `public/uploads/avatars/` (относительно корня проекта)

### Настройка путей через переменные окружения

Можно изменить пути через переменные окружения:

```bash
# Путь к базе данных
DB_PATH=/path/to/database

# Путь к загруженным файлам
UPLOADS_PATH=/path/to/uploads
```

**Важно:** 
- Папки `public/db/` и `public/uploads/` добавлены в `.gitignore` и не попадут в репозиторий
- При первом запуске создайте структуру папок или используйте `npm run init-db` для создания файлов базы данных

## Резервное копирование

Рекомендуется регулярно делать резервные копии файлов базы данных:

```bash
# Создание резервной копии
tar -czf backup-$(date +%Y%m%d).tar.gz public/db/

# Восстановление из резервной копии
tar -xzf backup-20240101.tar.gz
```

## Тесты

Работа с базой данных покрыта тестами. См. [TESTS.md](./TESTS.md) для подробной информации.

**Тесты проверки связей в БД:**
- `tests/routes/skills.test.ts` - тесты проверки существования subcategoryId при создании навыка
- `tests/routes/subcategories.test.ts` - тесты проверки существования categoryId при создании подкатегории
- `tests/register.test.ts` - тесты проверки существования cityId при регистрации пользователя
- `tests/routes/likes.test.ts` - тесты проверки существования toUserId при создании лайка

Запуск тестов:
```bash
npm run test:routes # Тесты API маршрутов (требуют запущенного сервера)
npm run test:register # Тесты регистрации (требуют запущенного сервера)
```

